# 🎨 Архитектура системы смены статусов

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         TELEGRAM КАНАЛ ПРОЕКТА                           │
│                                                                           │
│  Пользователь пишет: "АР-001 ок"                                        │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      TELEGRAM BOT (bot/index.ts)                         │
│                                                                           │
│  • Перехватывает сообщение через bot.on('message')                      │
│  • Проверяет наличие текста                                              │
│  • Пропускает команды (начинающиеся с /)                                │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│              ПАРСЕР АЛИАСОВ (utils/statusAliases.ts)                     │
│                                                                           │
│  parseStatusCommands("АР-001 ок")                                        │
│  ↓                                                                        │
│  [{                                                                       │
│    albumCode: "АР-001",                                                  │
│    statusCode: "accepted",                                               │
│    originalAlias: "ок"                                                   │
│  }]                                                                       │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      БАЗА ДАННЫХ (MySQL)                                 │
│                                                                           │
│  1. Найти проект по telegram_chat_id                                     │
│     SELECT p.id FROM projects p                                          │
│     JOIN project_channels pc ON p.id = pc.project_id                     │
│     WHERE pc.telegram_chat_id = ?                                        │
│                                                                           │
│  2. Найти альбом по коду в проекте                                       │
│     SELECT id, status_id FROM albums                                     │
│     WHERE project_id = ? AND code = 'АР-001'                            │
│                                                                           │
│  3. Получить ID нового статуса                                           │
│     SELECT id FROM album_statuses                                        │
│     WHERE code = 'accepted'                                              │
│                                                                           │
│  4. Обновить статус альбома                                              │
│     UPDATE albums                                                        │
│     SET status_id = ?, last_status_at = NOW()                           │
│     WHERE id = ?                                                         │
│                                                                           │
│  5. Записать в историю                                                   │
│     INSERT INTO album_status_history                                     │
│     (album_id, old_status_id, new_status_id, ...)                       │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│              ФОРМАТИРОВАНИЕ ОТВЕТА (utils/statusAliases.ts)              │
│                                                                           │
│  formatStatusChangeResponse("АР-001", "accepted", true)                  │
│  ↓                                                                        │
│  "✅ Альбом АР-001 → Принято"                                           │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         TELEGRAM КАНАЛ ПРОЕКТА                           │
│                                                                           │
│  Бот отвечает: "✅ Альбом АР-001 → Принято"                            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 Схема базы данных

```
┌──────────────────┐
│    projects      │
│                  │
│  • id            │
│  • name          │
│  • code          │
│  • company_id    │
└────────┬─────────┘
         │
         │ 1:N
         │
         ▼
┌──────────────────┐         ┌──────────────────┐
│ project_channels │         │     albums       │
│                  │         │                  │
│  • project_id    │◄────────│  • id            │
│  • telegram_chat_│  1:N    │  • project_id    │
│    id            │         │  • code          │
│  • chat_title    │         │  • status_id  ───┼──┐
└──────────────────┘         │  • last_status_  │  │
                             │    at            │  │
                             └────────┬─────────┘  │
                                      │            │
                                      │ 1:N        │ N:1
                                      │            │
                                      ▼            ▼
                             ┌──────────────────────────────┐
                             │  album_status_history        │
                             │                              │
                             │  • id                        │
                             │  • album_id                  │
                             │  • old_status_id          ───┼──┐
                             │  • new_status_id          ───┼──┤
                             │  • changed_by_user_id        │  │
                             │  • changed_by_telegram_id    │  │
                             │  • comment                   │  │
                             │  • created_at                │  │
                             └──────────────────────────────┘  │
                                                               │
                                                               │ N:1
                                                               │
                                                               ▼
                             ┌──────────────────┐
                             │ album_statuses   │
                             │                  │
                             │  • id            │
                             │  • code          │
                             │  • name          │
                             │  • color_hex     │
                             └──────────────────┘
```

---

## 🔄 Поток данных при смене статуса через API

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         FRONTEND (React)                                 │
│                                                                           │
│  await fetch('/api/companies/1/projects/1/albums/1/status', {           │
│    method: 'PUT',                                                        │
│    body: JSON.stringify({ statusCode: 'accepted' })                     │
│  })                                                                      │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    МАРШРУТ (routes/companies.ts)                         │
│                                                                           │
│  router.put(                                                             │
│    '/:companyId/projects/:projectId/albums/:albumId/status',            │
│    authenticateToken,                                                    │
│    albumController.updateAlbumStatus                                     │
│  )                                                                       │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│            MIDDLEWARE (middleware/auth.ts)                               │
│                                                                           │
│  • Проверяет JWT токен                                                   │
│  • Извлекает user_id                                                     │
│  • Добавляет в req.user                                                  │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│         КОНТРОЛЛЕР (controllers/albumController.ts)                      │
│                                                                           │
│  updateAlbumStatus(req, res)                                             │
│  • Валидация statusCode                                                  │
│  • Проверка прав доступа                                                 │
│  • Обновление в БД                                                       │
│  • Запись в историю                                                      │
│  • Возврат результата                                                    │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         FRONTEND (React)                                 │
│                                                                           │
│  Получает ответ:                                                         │
│  {                                                                        │
│    message: "Album status updated successfully",                         │
│    album: { id: 1, code: "АР-001", ... }                                │
│  }                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 Карта алиасов статусов

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            STATUS ALIASES                                │
└─────────────────────────────────────────────────────────────────────────┘

waiting (Ожидание)
  ├─ "ожидание"
  ├─ "ожидаем"
  ├─ "ожидает"
  └─ "⏳"

upload (Выгрузка)
  ├─ "выгрузка"
  ├─ "загрузка"
  ├─ "выгрузил"
  ├─ "загрузил"
  ├─ "📤"
  └─ "⬆️"

sent (Отправлено)
  ├─ "отправлено"
  ├─ "отправил"
  ├─ "отправила"
  ├─ "отправили"
  ├─ "→"
  ├─ "➡️"
  └─ "✉️"

accepted (Принято)
  ├─ "принято"
  ├─ "принял"
  ├─ "приняла"
  ├─ "приняли"
  ├─ "ок"
  ├─ "ok"
  ├─ "+"
  ├─ "✓"
  ├─ "✅"
  └─ "👍"

remarks (Замечания)
  ├─ "замечания"
  ├─ "замечание"
  ├─ "доработка"
  ├─ "доработать"
  ├─ "!"
  ├─ "!!"
  ├─ "❌"
  ├─ "⚠️"
  └─ "👎"

production (В производстве)
  ├─ "производство"
  ├─ "впроизводстве"
  ├─ "впроизводство"
  ├─ "🏭"
  └─ "⚙️"
```

---

## 📝 Регулярное выражение для парсинга

```javascript
// Паттерн: <КОД_АЛЬБОМА> <АЛИАС_СТАТУСА>
const ALBUM_STATUS_PATTERN = /([А-ЯA-Z]{2,4}-\d{3,4})\s+(.+?)(?:\s|$)/gi;

Примеры совпадений:
✅ "АР-001 ок"         → { albumCode: "АР-001", alias: "ок" }
✅ "КР-002 замечания"  → { albumCode: "КР-002", alias: "замечания" }
✅ "OVVK-123 +"        → { albumCode: "OVVK-123", alias: "+" }
✅ "ES-9999 ✅"        → { albumCode: "ES-9999", alias: "✅" }

❌ "просто текст"      → нет совпадений
❌ "001 ок"            → нет совпадений (нет префикса)
❌ "АР ок"             → нет совпадений (нет номера)
```

---

## 🔐 Безопасность и валидация

```
┌──────────────────┐
│ Входящий запрос  │
└────────┬─────────┘
         │
         ▼
┌──────────────────────────────────┐
│ 1. Аутентификация                │
│    ✓ JWT токен валиден?          │
│    ✓ Пользователь существует?    │
└────────┬─────────────────────────┘
         │
         ▼
┌──────────────────────────────────┐
│ 2. Валидация параметров          │
│    ✓ statusCode присутствует?    │
│    ✓ statusCode валиден?         │
└────────┬─────────────────────────┘
         │
         ▼
┌──────────────────────────────────┐
│ 3. Проверка прав доступа         │
│    ✓ Альбом принадлежит проекту? │
│    ✓ Проект принадлежит компании?│
│    ✓ Пользователь в компании?    │
└────────┬─────────────────────────┘
         │
         ▼
┌──────────────────────────────────┐
│ 4. Выполнение операции           │
│    • Обновление статуса          │
│    • Запись в историю            │
│    • Логирование                 │
└────────┬─────────────────────────┘
         │
         ▼
┌──────────────────┐
│ Успешный ответ   │
└──────────────────┘
```
